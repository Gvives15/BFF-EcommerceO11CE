{% extends "panel/base.html" %}
{% load static %}

{% block title %}Agregar Producto{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Agregar Nuevo Producto</h1>
                <a href="{% url 'panel:stock_list' %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Volver al Inventario
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información del Producto</h5>
                </div>
                <div class="card-body">
                    {% include "panel/_flash.html" %}
                    
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="name" name="name" required 
                                           value="{{ form.name.value|default:'' }}" maxlength="200">
                                    {% if form.name.errors %}
                                        <div class="text-danger small">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sku" class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="sku" name="sku" required 
                                           value="{{ form.sku.value|default:'' }}" maxlength="50">
                                    <div class="form-text">Código único del producto</div>
                                    {% if form.sku.errors %}
                                        <div class="text-danger small">{{ form.sku.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label">Categoría</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="">Seleccionar categoría</option>
                                        <option value="electronics" {% if form.category.value == 'electronics' %}selected{% endif %}>Electrónicos</option>
                                        <option value="clothing" {% if form.category.value == 'clothing' %}selected{% endif %}>Ropa</option>
                                        <option value="food" {% if form.category.value == 'food' %}selected{% endif %}>Alimentos</option>
                                        <option value="books" {% if form.category.value == 'books' %}selected{% endif %}>Libros</option>
                                        <option value="home" {% if form.category.value == 'home' %}selected{% endif %}>Hogar</option>
                                        <option value="sports" {% if form.category.value == 'sports' %}selected{% endif %}>Deportes</option>
                                        <option value="other" {% if form.category.value == 'other' %}selected{% endif %}>Otros</option>
                                    </select>
                                    {% if form.category.errors %}
                                        <div class="text-danger small">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price" class="form-label">Precio *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="price" name="price" 
                                               step="0.01" min="0" required value="{{ form.price.value|default:'' }}">
                                    </div>
                                    {% if form.price.errors %}
                                        <div class="text-danger small">{{ form.price.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      maxlength="1000">{{ form.description.value|default:'' }}</textarea>
                            <div class="form-text">Descripción detallada del producto (máximo 1000 caracteres)</div>
                            {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="brand" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="brand" name="brand" 
                                           value="{{ form.brand.value|default:'' }}" maxlength="100">
                                    {% if form.brand.errors %}
                                        <div class="text-danger small">{{ form.brand.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="weight" class="form-label">Peso (kg)</label>
                                    <input type="number" class="form-control" id="weight" name="weight" 
                                           step="0.01" min="0" value="{{ form.weight.value|default:'' }}">
                                    {% if form.weight.errors %}
                                        <div class="text-danger small">{{ form.weight.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="length" class="form-label">Largo (cm)</label>
                                    <input type="number" class="form-control" id="length" name="length" 
                                           step="0.1" min="0" value="{{ form.length.value|default:'' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="width" class="form-label">Ancho (cm)</label>
                                    <input type="number" class="form-control" id="width" name="width" 
                                           step="0.1" min="0" value="{{ form.width.value|default:'' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="height" class="form-label">Alto (cm)</label>
                                    <input type="number" class="form-control" id="height" name="height" 
                                           step="0.1" min="0" value="{{ form.height.value|default:'' }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="min_stock" class="form-label">Stock Mínimo</label>
                                    <input type="number" class="form-control" id="min_stock" name="min_stock" 
                                           min="0" value="{{ form.min_stock.value|default:'0' }}">
                                    <div class="form-text">Cantidad mínima para alertas de stock bajo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_stock" class="form-label">Stock Máximo</label>
                                    <input type="number" class="form-control" id="max_stock" name="max_stock" 
                                           min="0" value="{{ form.max_stock.value|default:'' }}">
                                    <div class="form-text">Cantidad máxima recomendada en inventario</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if form.is_active.value != False %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    Producto activo
                                </label>
                                <div class="form-text">Los productos inactivos no aparecerán en el catálogo</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requires_expiry" name="requires_expiry">
                                <label class="form-check-label" for="requires_expiry">
                                    Producto con fecha de vencimiento
                                </label>
                                <div class="form-text">Marcar si el producto requiere control de fechas de vencimiento</div>
                            </div>
                        </div>

                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'panel:stock_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 1.25rem;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.form-control:focus, .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.text-danger {
    font-size: 0.875rem;
}

.form-text {
    font-size: 0.8rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .d-flex > a, .d-flex > button {
        margin-top: 0.5rem;
        width: 100%;
    }
}
</style>

<script>
// Auto-generar SKU basado en el nombre
document.getElementById('name').addEventListener('input', function() {
    const name = this.value;
    const skuField = document.getElementById('sku');
    
    if (name && !skuField.value) {
        // Generar SKU simple basado en el nombre
        const sku = name.toUpperCase()
            .replace(/[^A-Z0-9]/g, '')
            .substring(0, 10) + '-' + Math.floor(Math.random() * 1000);
        skuField.value = sku;
    }
});

// Validación de stock mínimo vs máximo
document.getElementById('max_stock').addEventListener('input', function() {
    const minStock = parseInt(document.getElementById('min_stock').value) || 0;
    const maxStock = parseInt(this.value) || 0;
    
    if (maxStock > 0 && maxStock < minStock) {
        this.setCustomValidity('El stock máximo debe ser mayor al stock mínimo');
    } else {
        this.setCustomValidity('');
    }
});

// Contador de caracteres para descripción
document.getElementById('description').addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;
    const remaining = maxLength - currentLength;
    
    let helpText = this.nextElementSibling;
    if (helpText && helpText.classList.contains('form-text')) {
        helpText.textContent = `Descripción detallada del producto (${remaining} caracteres restantes)`;
        
        if (remaining < 50) {
            helpText.classList.add('text-warning');
        } else {
            helpText.classList.remove('text-warning');
        }
    }
});
</script>
{% endblock %}