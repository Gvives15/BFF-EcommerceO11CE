{% extends "panel/base.html" %}
{% block title %}Detalle de stock — O11CE{% endblock %}

{% block extra_css %}
<style>
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.form-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-group input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.form-group input:invalid {
  border-color: #dc3545;
}

.help-text {
  display: block;
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.message {
  padding: 8px 12px;
  border-radius: 4px;
  margin-top: 8px;
  font-size: 14px;
}

.message.info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.message.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.message.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

button.primary {
  background-color: #007bff;
  color: white;
  border: 1px solid #007bff;
}

button.secondary {
  background-color: #6c757d;
  color: white;
  border: 1px solid #6c757d;
}

button.primary:not(:disabled):hover {
  background-color: #0056b3;
  border-color: #0056b3;
}

button.secondary:not(:disabled):hover {
  background-color: #545b62;
  border-color: #545b62;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="row">
    <a href="/panel/stock/">← Volver</a>
    <h2 style="margin:0">Detalle de stock</h2>
  </div>

  <div class="row mt12">
    <div><label>Producto</label><div id="p-code" class="muted">—</div></div>
    <div><label>Nombre</label><div id="p-name" class="muted">—</div></div>
    <div><label>Total en mano</label><div id="p-total" class="muted">—</div></div>
    <div><label>Estado</label><div id="p-state" class="muted">—</div></div>
  </div>

  <table class="mt12" id="tbl-lots">
    <thead>
      <tr><th>ID</th><th>Lote</th><th>Vence</th><th>En mano</th><th>Depósito</th><th>Near</th><th>Días</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card mt16">
  <strong>➕ Entrada rápida</strong>
  <div class="row mt12">
    <div class="form-group">
      <label for="en-lot">Código de lote *</label>
      <input id="en-lot" placeholder="Ej: A1, LOTE001" required/>
      <small class="help-text">Identificador único del lote</small>
    </div>
    <div class="form-group">
      <label for="en-exp">Fecha de vencimiento *</label>
      <input id="en-exp" type="date" required/>
      <small class="help-text">Fecha límite de consumo</small>
    </div>
    <div class="form-group">
      <label for="en-qty">Cantidad *</label>
      <input id="en-qty" type="number" step="0.001" min="0.001" placeholder="0.000" style="width:140px" required/>
      <small class="help-text">Debe ser mayor a 0</small>
    </div>
    <div class="form-group">
      <label for="en-cost">Costo unitario *</label>
      <input id="en-cost" type="number" step="0.01" min="0" placeholder="0.00" style="width:140px" required/>
      <small class="help-text">Precio de compra por unidad</small>
    </div>
    <div class="form-group">
      <button id="btn-entry" class="primary" disabled>Cargar entrada</button>
    </div>
  </div>
  <div id="en-msg" class="message"></div>
</div>

<div class="card mt16">
  <strong>➖ Salida FEFO (manual)</strong>
  <div class="row mt12">
    <div class="form-group">
      <label for="ex-qty">Cantidad a descontar *</label>
      <input id="ex-qty" type="number" step="0.001" min="0.001" placeholder="0.000" style="width:140px" required/>
      <small class="help-text">Se aplicará FEFO automáticamente</small>
    </div>
    <div class="form-group">
      <button id="btn-exit" class="secondary" disabled>Descontar stock</button>
    </div>
  </div>
  <div id="ex-msg" class="message"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_BASE = "/api/v1";
const PRODUCT_ID = {{ product_id|default:"0" }};

function el(id){ return document.getElementById(id); }
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

async function loadProduct(){
  const res = await fetch(`${API_BASE}/catalog/products/${PRODUCT_ID}`);
  if(res.status===404){ alert("Producto no encontrado"); return; }
  const p = await res.json();
  el('p-code').textContent = p.code;
  el('p-name').textContent = p.name;
}

async function loadStock(){
  const res = await fetch(`${API_BASE}/stock/${PRODUCT_ID}`);
  const data = await res.json();
  el('p-total').textContent = data.on_hand_total;
  el('p-state').textContent = data.low_stock ? "LOW STOCK" : "OK";

  const tb = document.querySelector('#tbl-lots tbody');
  tb.innerHTML = "";
  (data.lots||[]).forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.id}</td>
      <td><code>${l.lot_code}</code></td>
      <td>${l.expiry_date}</td>
      <td>${l.qty_on_hand}</td>
      <td>${l.warehouse || "-"}</td>
      <td>${l.near_expiry ? "Sí" : "No"}</td>
      <td>${l.days_to_expiry}</td>
    `;
    tb.appendChild(tr);
  });
}

// ---- Validaciones en tiempo real ----
function validateEntryForm(){
  const lot = el('en-lot').value.trim();
  const exp = el('en-exp').value;
  const qty = parseFloat(el('en-qty').value);
  const cost = parseFloat(el('en-cost').value);
  
  const isValid = lot && exp && qty > 0 && cost >= 0;
  el('btn-entry').disabled = !isValid;
  return isValid;
}

function validateExitForm(){
  const qty = parseFloat(el('ex-qty').value);
  const isValid = qty > 0;
  el('btn-exit').disabled = !isValid;
  return isValid;
}

function showMessage(elementId, message, type = 'info'){
  const msgEl = el(elementId);
  msgEl.textContent = message;
  msgEl.className = `message ${type}`;
  if(type === 'success'){
    setTimeout(() => {
      msgEl.textContent = '';
      msgEl.className = 'message';
    }, 3000);
  }
}

// ---- Entrada rápida ----
async function doEntry(){
  if(!validateEntryForm()) return;
  
  const lot = el('en-lot').value.trim();
  const exp = el('en-exp').value;
  const qty = el('en-qty').value;
  const cost = el('en-cost').value;
  
  el('btn-entry').disabled = true;
  showMessage('en-msg', 'Procesando entrada...', 'info');

  try {
    const csrftoken = getCookie('csrftoken');
    const res = await fetch(`${API_BASE}/movements/entry`, {
      method:"POST",
      headers: {"Content-Type":"application/json","X-CSRFToken":csrftoken},
      body: JSON.stringify({product_id: PRODUCT_ID, lot_code: lot, expiry_date: exp, qty: qty, unit_cost: cost})
    });
    const j = await res.json();
    
    if(res.status===201){
      showMessage('en-msg', `✓ Entrada registrada correctamente (ID: ${j.movement_id})`, 'success');
      // Limpiar formulario
      el('en-lot').value = '';
      el('en-exp').value = '';
      el('en-qty').value = '';
      el('en-cost').value = '';
      await loadStock();
    } else {
      let errorMsg = 'Error al registrar entrada';
      if(j.error === 'VALIDATION_ERROR'){
        errorMsg = `Validación: ${j.message}`;
      } else if(j.message){
        errorMsg = j.message;
      }
      showMessage('en-msg', errorMsg, 'error');
    }
  } catch(error) {
    showMessage('en-msg', 'Error de conexión. Intente nuevamente.', 'error');
  } finally {
    validateEntryForm();
  }
}

// ---- Salida FEFO manual ----
async function doExit(){
  if(!validateExitForm()) return;
  
  const qty = el('ex-qty').value;
  
  el('btn-exit').disabled = true;
  showMessage('ex-msg', 'Procesando salida FEFO...', 'info');

  try {
    const csrftoken = getCookie('csrftoken');
    const res = await fetch(`${API_BASE}/movements/exit`, {
      method:"POST",
      headers: {"Content-Type":"application/json","X-CSRFToken":csrftoken},
      body: JSON.stringify({product_id: PRODUCT_ID, qty: qty})
    });
    const j = await res.json();
    
    if(res.ok){
      const movCount = (j.movements||[]).length;
      showMessage('ex-msg', `✓ Salida FEFO procesada (${movCount} movimiento${movCount !== 1 ? 's' : ''})`, 'success');
      // Limpiar formulario
      el('ex-qty').value = '';
      await loadStock();
    } else {
      let errorMsg = 'Error al procesar salida';
      if(j.error === 'INSUFFICIENT_STOCK'){
        errorMsg = `Stock insuficiente: ${j.message}`;
      } else if(j.error === 'VALIDATION_ERROR'){
        errorMsg = `Validación: ${j.message}`;
      } else if(j.message){
        errorMsg = j.message;
      }
      showMessage('ex-msg', errorMsg, 'error');
    }
  } catch(error) {
    showMessage('ex-msg', 'Error de conexión. Intente nuevamente.', 'error');
  } finally {
    validateExitForm();
  }
}

// Wiring
document.getElementById('btn-entry').addEventListener('click', doEntry);
document.getElementById('btn-exit').addEventListener('click', doExit);

// Validaciones en tiempo real
['en-lot', 'en-exp', 'en-qty', 'en-cost'].forEach(id => {
  el(id).addEventListener('input', validateEntryForm);
  el(id).addEventListener('blur', validateEntryForm);
});

el('ex-qty').addEventListener('input', validateExitForm);
el('ex-qty').addEventListener('blur', validateExitForm);

// Init
loadProduct().then(() => {
  loadStock();
  validateEntryForm();
  validateExitForm();
});
</script>
{% endblock %}