{% extends "panel/base.html" %}
{% block title %}Alertas — O11CE{% endblock %}

{% block content %}
<div class="card">
  <div class="row">
    <div>
      <label>Evento</label><br/>
      <select id="f-event">
        <option value="">Todos</option>
        <option value="low_stock">low_stock</option>
        <option value="near_expiry">near_expiry</option>
        <option value="new_order">new_order</option>
      </select>
    </div>
    <div>
      <label>Desde (ISO)</label><br/>
      <input id="f-since" type="datetime-local"/>
    </div>
    <div>
      <label>Página</label><br/>
      <input id="f-page" type="number" min="1" value="1" style="width:90px"/>
    </div>
    <div>
      <label>Items</label><br/>
      <input id="f-size" type="number" min="1" max="100" value="20" style="width:90px"/>
    </div>
    <button id="btn-apply" class="right">Aplicar filtros</button>
    <button id="btn-refresh" title="Refrescar">↻</button>
  </div>

  <div class="mt12 flex">
    <span class="badge">Auto-refresh cada 30s</span>
    <span class="badge">Rate-limit: 6h</span>
  </div>

  <table class="mt12" id="tbl-alerts">
    <thead>
      <tr>
        <th>ID</th>
        <th>Evento</th>
        <th>Payload</th>
        <th>Creada</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="mt16 flex">
    <button id="btn-prev">« Anterior</button>
    <button id="btn-next">Siguiente »</button>
    <span class="right muted" id="meta"></span>
  </div>
</div>

<div class="card mt16">
  <div class="row">
    <strong>⚙️ Generar (demo)</strong>
    <button id="gen-low">Generar low_stock</button>
    <button id="gen-exp">Generar near_expiry</button>
  </div>
  <div class="mt8 flex">
    <input id="test-payload" placeholder='payload JSON (opcional para test)' style="flex:1" />
    <button id="gen-test">Crear alerta de test (new_order)</button>
    <span id="err" class="error"></span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_BASE = "/api/v1/notifications";

function fmtDate(d){
  try{ return new Date(d).toLocaleString(); }catch(e){ return d }
}
function el(id){ return document.getElementById(id); }

async function fetchAlerts(){
  const ev = el('f-event').value;
  const sinceRaw = el('f-since').value;
  const page = parseInt(el('f-page').value || "1");
  const size = parseInt(el('f-size').value || "20");

  let qs = `?page=${page}&page_size=${size}`;
  if (ev) qs += `&event=${encodeURIComponent(ev)}`;
  if (sinceRaw){
    const iso = new Date(sinceRaw).toISOString();
    qs += `&since=${encodeURIComponent(iso)}`;
  }

  const res = await fetch(`${API_BASE}/alerts${qs}`);
  const data = await res.json();
  renderTable(data);
}

function renderTable(data){
  const tb = document.querySelector('#tbl-alerts tbody');
  tb.innerHTML = "";
  (data.items || []).forEach(row=>{
    const tr = document.createElement('tr');
    const ev = row.event;
    const payloadPretty = JSON.stringify(row.payload, null, 2);
    tr.innerHTML = `
      <td>${row.id}</td>
      <td><span class="pill ev-${ev}">${ev}</span></td>
      <td><pre style="margin:0;color:#cbd5e1;white-space:pre-wrap">${payloadPretty}</pre></td>
      <td>${fmtDate(row.created_at)}</td>
    `;
    tb.appendChild(tr);
  });
  el('meta').textContent = `Página ${data.page} · Total ${data.total}`;
}

function page(delta){
  const p = Math.max(1, (parseInt(el('f-page').value||"1")+delta));
  el('f-page').value = p;
  fetchAlerts();
}

// ---- Generadores (demo) ----
async function postGenerate(type){
  const res = await fetch(`${API_BASE}/alerts/generate?type=${encodeURIComponent(type)}`, {method:"POST"});
  const j = await res.json();
  await fetchAlerts();
}

function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

async function postTestAlert(){
  el('err').textContent = "";
  let payload = {};
  try{
    const raw = el('test-payload').value.trim();
    payload = raw ? JSON.parse(raw) : {"order_id":7001,"customer_id":1,"total":"0.00"};
  }catch(e){
    el('err').textContent = "Payload inválido (JSON)";
    return;
  }
  const csrftoken = getCookie('csrftoken'); // si usás CSRF
  const res = await fetch(`${API_BASE}/alerts/test`, {
    method:"POST",
    headers: {"Content-Type":"application/json", "X-CSRFToken": csrftoken},
    body: JSON.stringify({event:"new_order", payload})
  });
  await res.json();
  await fetchAlerts();
}

// ---- Wiring ----
el('btn-apply').addEventListener('click', ()=>{ el('f-page').value=1; fetchAlerts(); });
el('btn-refresh').addEventListener('click', fetchAlerts);
el('btn-prev').addEventListener('click', ()=>page(-1));
el('btn-next').addEventListener('click', ()=>page(+1));
el('gen-low').addEventListener('click', ()=>postGenerate('low_stock'));
el('gen-exp').addEventListener('click', ()=>postGenerate('near_expiry'));
el('gen-test').addEventListener('click', postTestAlert);

// Auto-refresh cada 30s
setInterval(fetchAlerts, 30000);

// Primera carga
fetchAlerts();
</script>
{% endblock %}
